@model Core.Models.Car

@{
    ViewData["Title"] = "Details";
}

<div class="row">
    <div class="col-4">
        <h1>Car</h1>
    </div>
    <div class="offset-7 col-1">
        <a class="btn btn-dark" asp-action="Index">Back</a>
    </div>
</div>

<div>
    <form id="car-form" asp-action="Edit" class="">

        <div class="navbar navbar-form navbar-expand-sm bg-dark border box-shadow rounded flex-row justify-content-between">
            <div class="col-md-2 navbar-brand text-light"><b>@Model.LicenseNumber</b></div>
            <div class=" btn-group non-editable pr-3">
                <button id="edit-btn" type="button" class="btn btn-danger mt-auto non-editable">Edit</button>
            </div>
            <div class="btn-group editable col-md-2 d-none">
                <button id="save-btn" type="submit" value="Save" class="btn btn-success mt-auto">Save</button>
                <button id="cancel-btn" type="button" value="Cancel" class="btn btn-danger mt-auto">Cancel</button>
            </div>
        </div>
        <div class="container pt-3 border border-top-0 rounded-bottom">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="CarId" />

            <div class="form-row">
                <div class="col-md-6 non-editable">
                    <label asp-for="LicenseNumber" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.LicenseNumber</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>

                <div class="col-md-4 editable d-none">
                    <label asp-for="LicenseNumber" class="control-label"></label>
                    <div class="input-group">
                        <input id="input-licensenumber"
                               asp-for="LicenseNumber" class="form-control" />
                        <div class="input-group-append">
                        </div>
                    </div>
                </div>
                <span asp-validation-for="LicenseNumber" class="text-danger"></span>
            </div>

            <div class="form-row">
                <div class="col-md-6 non-editable">
                    <label asp-for="Model.Brand" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.Model.Brand.Name</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>

                <div id="brand-select-group" class="col-md-5 editable d-none">
                    <label asp-for="Model.Brand" class="control-label"></label>
                    <div class="input-group">
                        <select id="brand-select"
                                class="custom-select"
                                asp-for="Model.Brand.BrandId"
                                asp-items="@ViewBag.BrandId">
                        </select>
                        <div class="input-group-append">
                            <button id="new-brand-btn" class="btn btn-success" type="button">New</button>
                        </div>
                    </div>
                </div>

                <div id="brand-create-group" class="col-md-5 d-none">
                    <label asp-for="Model.Brand" class="control-label"></label>
                    <div class="input-group">
                        <input id="brand-text-input" value="" asp-for="Model.Brand" class="form-control" />
                        <div class="input-group-append">
                            <button id="create-brand-btn" class="btn btn-success" type="button">Save</button>
                        </div>
                        <div class="input-group-append">
                            <button id="cancel-brand-btn" class="btn btn-danger" type="button">Cancel</button>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="Model.Brand" class="text-danger"></span>

                <div class="col-md-6 non-editable">
                    <label asp-for="Model" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.Model.Name</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>

                <div id="model-select-group" class="offset-md-1 col-md-5 editable d-none">
                    <label asp-for="Model" class="control-label"></label>
                    <div class="input-group">
                        <select id="model-select"
                                class="custom-select"
                                asp-for="Model.ModelId"
                                asp-items="@ViewBag.ModelId">
                        </select>
                        <div class="input-group-append">
                            <button id="new-model-btn" class="btn btn-success" type="button">New</button>
                        </div>
                    </div>
                </div>

                <div id="model-create-group" class="offset-md-1 col-md-5 d-none">
                    <label asp-for="Model" class="control-label"></label>
                    <div class="input-group">
                        <input id="model-text-input" asp-for="Model" value="" class="form-control" />
                        <div class="input-group-append">
                            <button id="create-model-btn" class="btn btn-success" type="button">Save</button>
                        </div>
                        <div class="input-group-append">
                            <button id="cancel-model-btn" class="btn btn-danger" type="button">Cancel</button>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="Model" class="text-danger"></span>
            </div>

            <div class="form-row mt-2">

                <div class="col-md-6 non-editable ">
                    <label asp-for="Owner" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.Owner.Name</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>
                <div class="col-md-4 editable d-none">
                    <label asp-for="Owner" class="control-label"></label>
                    <div class="input-group">
                        <select id="owner-select"
                                class="custom-select"
                                asp-for="Owner.OwnerId"
                                asp-items="@ViewBag.OwnerId">
                        </select>
                        <div class="input-group-append">
                        </div>
                    </div>
                </div>
                <span asp-validation-for="Owner" class="text-danger"></span>


                <div class="col-md-6 non-editable">
                    <label asp-for="Driver" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.Driver.Name</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>

                <div class="offset-md-2 col-md-4 editable d-none">
                    <label asp-for="Driver" class="control-label"></label>
                    <div class="input-group">
                        <select id="driver-select"
                                class="custom-select "
                                asp-for="Driver.OwnerId"
                                asp-items="@ViewBag.DriverId">
                        </select>
                        <div class="input-group-append">
                        </div>
                    </div>
                </div>
                <span asp-validation-for="Owner" class="text-danger"></span>
            </div>

            <div class="form-row mt-2 mb-3">

                <div class="col-md-6 non-editable">
                    <label asp-for="Status" class="control-label"></label>
                    <div class="ml-2 font-weight-bold">
                        <span>@Model.Status</span>
                    </div>
                    <hr class="mt-1 mb-2" />
                </div>

                <div class="col-md-4 editable d-none">
                    <label asp-for="Status" class="control-label"></label>
                    <div class="input-group">
                        <select id="status-select"
                                asp-for="Status" class="custom-select"
                                asp-items="@Html.GetEnumSelectList<Core.Enums.StatusEnum>()">
                        </select>
                        <div class="input-group-append">
                        </div>
                    </div>
                </div>
                <span asp-validation-for="Status" class="text-danger"></span>
            </div>
        </div>
    </form>
</div>

@section scripts {

    <script>
        $(document).ready(function () {

            $('#edit-btn').click(enableEdit);
            $('#cancel-btn').click(disableEdit);

            $('#new-brand-btn').click(function () { enablePropertyCreate('brand'); });
            $('#new-model-btn').click(function () { enablePropertyCreate('model'); });
            $('#cancel-brand-btn').click(function () { disablePropertyCreate('brand'); });
            $('#cancel-model-btn').click(function () { disablePropertyCreate('model'); });
            $('#create-brand-btn').click(createBrand);
            $('#create-model-btn').click(createModel);


            $('#brand-select').change(getModels);
            $('#brand-select option:contains(@Model.Model.Brand.Name)').prop('selected', true);

            getModels();
            $('#model-select option:contains(@Model.Model.Name)').prop('selected', true);

            function enablePropertyCreate(property) {
                $('#' + property + '-create-group').removeClass('d-none');
                $('#' + property + '-select-group').addClass('d-none');
            }

            function disablePropertyCreate(property) {
                $('#' + property + '-create-group').addClass('d-none');
                $('#' + property + '-select-group').removeClass('d-none');
            }

            function createBrand() {
                let actionUrl = "/Api/BrandsApiEndpoint/"
                let name = $('#brand-text-input').val();
                let brand = {
                    Name: name
                }

                $.post({
                    url: actionUrl,
                    data: JSON.stringify(brand),
                    contentType: 'application/json',
                    succes: (data) => {
                        console.log('Success');
                        console.log(data);
                    },
                    error: (data) => {
                        console.log('Failed');
                        console.log(data);
                    }
                });

                location.reload();
            }

            function createModel() {
                let actionUrl = "/Api/ModelsApiEndpoint/"
                let name = $('#model-text-input').val();
                let brand = {
                    BrandId: $("#brand-select").val(),
                    Name: $("#brand-select option:selected").text()
                };

                let model = {
                    Brand: brand,
                    Name: name
                }

                $.post({
                    url: actionUrl,
                    data: JSON.stringify(model),
                    contentType: 'application/json',
                    succes: (data) => {
                        $('body').html(data);
                        console.log('Success');
                        console.log(data);
                    },
                    error: (data) => {
                        console.log('Failed');
                        console.log(data);
                    }
                });

                location.reload();
            }

            function disableEdit() {
                $(".editable").addClass('d-none');
                $(".non-editable").removeClass('d-none');
            }

            function enableEdit() {
                $(".editable").removeClass('d-none');
                $(".non-editable").addClass('d-none');
                $('#owner-select option:contains(@Model.Owner.Name)').prop('selected', true);
                $('#driver-select option:contains(@Model.Driver.Name)').prop('selected', true);
                $('#status-select option:contains(@Model.Status)').prop('selected', true);
            }

            function getModels() {
                let actionUrl = "/Api/ModelsApiEndpoint/GetModelByBrand?id=";
                let brandId = $('#brand-select').val();
                let modelSelect = $('#model-select');

                $.post({
                    url: actionUrl + brandId,
                    success: (data) => {
                        modelSelect.empty();

                        $.each(data.data, function (i, item) {
                            modelSelect.append($('<option></option>').val(item.modelId).html(item.name));
                        });
                    },
                    error: (data) => {
                        console.log('Failed');
                        console.log(data);
                    }
                });
            }
        });
    </script>
}